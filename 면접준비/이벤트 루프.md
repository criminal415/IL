### 이벤트 루프?

callback Event Queue에서 하나씩 꺼내서 동작시키는 Loop를 말한다.

자바스크립트는 싱글 스레드 기반 언어이기 때문에, 한번에 하나씩 작업을 진행한다. 그러나 자바스크립트가 사용되는 환경을 생각해보면, 많은 작업이 동시에 처리되고 있는 것을 알 수 있다.

> 스레드 : 프로세스가 할당받은 메모리를 실행하는 단위, 하나의 프로세스가 여러 스레드로 나뉠 수 있다.

이는 자바스크립트(브라우저나 node.js)는 이벤트 루프를 이용해서 비동기 방식으로 동시성을 지원하기 때문이고, 이벤트 발생 시 호출되는 콜백 함수들을 태스크 큐에 전달하고, 테스크 큐에 담겨있는 콜백 함수들을 콜 스택에 넘겨준다.

웹 api에서 제공하는 비동기 함수들과 워커 종류를 제외한 대부분의 자바스크립트 코드가 메인 스레드에서 실행된다.(브라우저 화면을 그리는 렌더링 작업도 이곳에서 실행)

메인 스레드와 같은 싱글 스레드에서 하나의 작업이 오랫동안 실행되어서도 안 되고, 여러 작업 중 어떤 작업을 우선으로 동작 시킬 것인가 결정하는 것도 매우 중요하다. 또한, 작업 간 전환 속도를 빠르게 하여 한 번에 하나의 작업씩 수행하지만 마치 동시에 수행하는 것처럼 동작해야한다.(동시성과 병렬성) 이러한 컨트롤을 이벤트 루프가 관리한다.

![image](https://user-images.githubusercontent.com/90595291/150684350-89940bd4-4849-4838-a9d0-beb60ecfa92d.png)

> 동시성 : 적어도 두 개의 스레드가 진행 중일 때 존재하는 조건이며, 가상 병렬 처리의 한 형태로 시간 분할(time-slicing)을 포함한다. 우리가 흔히 '동시'라고 이야기 하지만 컴퓨터(코어)는 한번에 하나의 명령어만 처리할 수 있다. 즉, 두개 이상의 알고리즘이 하나의 코어내에서 스레드간에 빠르게 교차되면서 실행되기 때문에 '동시'라고 느끼는 것이다.

> 참고: 스레드A와 스레드B가 교차되며 실행되는 부분을 Context Switching(문맥교환)이라고 한다.

![image](https://user-images.githubusercontent.com/90595291/150684418-0e622f73-5ed0-4817-8d23-e2a71f056773.png)

> 병렬성은 적어도 2개 이상의 코어가 있어야 하며, 병렬성도 동시성을 의미하지만 동시성과의 차이는 각 코어내의 스레드가 실제로 동시에 명령어를 실행할 수 있음을 말한다. 따라서, 두개의 알고리즘이 정확히 같은 시점에 실행될 때 이를 병렬적이라고 말할 수 있다.

### 화면 갱신이 필요하다면 랜더링 파이프라인으로 이동

> requestAnimationFrame(rAF)

화면 갱신이 필요한 경우는 이벤트 루프가 판단한다. 예를 들면, 사용자가 스크롤 이동을 했거나, 어떤 요소를 클릭했을 때 등 화면을 갱신 해야 될 필요가 있을때 렌더링 파이프라인으로 이동한다.

여기서 자바스크립트 코드 상에 rAF api를 사용하면 이벤트 루프가 모니터 주사율(Hz)에 맞춰 렌더링 파이프라인으로 들어가려고 노력한다.(싱글 스레드이기 때문에 반드시 주기가 지켜지지는 않는다.) 보통은 모니터 주사율이 60Hz기 때문에 화면 갱신 속도도 60fps이고 이는 1프레임이 16ms 정도 나와야 함을 의미한다.

> 1프레임이란, 렌더링 파이프라인에 진입 했을 때부터 다음 파이프라인 진입까지를 의미한다.

### task queue에 있는 콜백을 하나씩 실행

promise와는 다르게 task queue는 콜백을 하나 실행하고 이벤트 루프를 놓아주어 다른 동작을 수행할 수 있도록 한다는 것이다.

### ECMAScript에는 이벤트 루프가 없다

V8과 같은 자바스크립트 엔진은 단일 호출 스택(call stack)을 사용하며, 요청이 들어올 때마다 해당 요청을 순차적으로 호출 스택에 담아 처리한다. 비동기 적인 요청(동시성)에 대한 처리는 자바스크립트 엔진을 구동하는 환경, 즉 브라우저나 Node.js가 담당한다.

먼저 브라우저 환경을 간단하게 그림으로 표현하면 다음과 같다.
![image](https://user-images.githubusercontent.com/90595291/150747150-168fc3f8-629b-41ff-ab44-53986d39daf2.png)

위 그림에서 볼 수 있듯이 실제로 우리가 비동기 호출을 위해 사용하는 setTimeout이나 XMLHttpRequest와 같은 함수들은 자바스크립트 엔진이 아닌 Web API 영역에 따로 정의되어 있다. 또한 이벤트 루프와 태스크 큐와 같은 장치도 자바스크립트 엔진 외부에 구현되어 있는 것을 볼 수 있다.

다음은 Node.js 환경이다.
![image](https://user-images.githubusercontent.com/90595291/150747878-4a4519fd-73b0-4833-ac9a-ea782e1e47d4.png)

이 그림에서도 브라우저의 환경과 비슷한 구조를 볼 수 있다. 잘 알려진 대로 Node.js는 비동기 IO를 지원하기 위해 libuv 라이브러리를 사용하며, 이 libuv가 이벤트 루프를 제공한다. 자바스크립트 엔진은 비동기 작업을 위해 Node.js의 API를 호출하며, 이때 넘겨진 콜백은 libuv의 이벤트 루프를 통해 스케쥴되고 실행된다.

자바스크립트가 '단일 스레드' 기반의 언어라는 말은 '자바스크립트 엔진이 단일 호출 스택을 사용한다'는 관점에서만 사실이다. 실제 자바스크립트가 구동되는 환경(브라우저, Node.js등)에서는 주로 여러 개의 스레드가 사용되며, 이러한 구동 환경이 단일 호출 스택을 사용하는 자바 스크립트 엔진과 상호 연동하기 위해 사용하는 장치가 바로 '이벤트 루프'인 것이다.

### 단일 호출 스택과 Run-to-Completion

자바스크립트의 함수가 실행되는 방식을 보통 "Run to Completion" 이라고 말한다. 이는 하나의 함수가 실행되면 이 함수의 실행이 끝날 때까지는 다른 어떤 작업도 중간에 끼어들지 못한다는 의미이다. 자바스크립트 엔진은 하나의 호출 스택을 사용하며, 현재 스택에 쌓여있는 모든 함수들이 실행을 마치고 스택에서 제거되기 전까지는 다른 어떠한 함수도 실행될 수 없기 때문이다.

### task queue, event roof

```MDN의 이벤트 루프 설명의 코드
while(queue.waitForMessage()){
  queue.processNextMessage();
}
```

위 코드의 waitForMessage() 메소드는 현재 실행중인 태스크가 없을 때 다음 태스크가 큐에 추가될 때까지 하는 역할을 한다. 이런 식으로 이벤트 루프는 현재 실행중인 태스크가 없는지와 태스크 큐에 태스크가 있는지를 반복적으로 확인하는 것이다.

- 모든 비동기 API들은 작업이 완료되면 콜백 함수를 태스크 큐에 추가한다.
- 이벤트 루프는 '현재 실행중인 태스크가 없을 때(주로 호출 스택이 비워졌을 때) 태스크 큐의 첫 번째 태스크를 꺼내와 실행한다.

### 비동기 API와 try-catch

### setTimeout(fn, 0)

### Promise와 이벤트 루프
